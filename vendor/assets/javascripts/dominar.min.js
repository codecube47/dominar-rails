/* dominar.js - Copyright 2015 Gary Green. Licensed under the Apache License, Version 2.0 */!function(t){"undefined"!=typeof exports?module.exports=t:window.Dominar=t(jQuery,Validator)}(function(t,e){function i(e,i,s){this.$form=e,this.options=i||{},this.config=s||t.extend({},this.configDefaults,s),this.fields={},this.bindEvents()}function s(e,i,s){this.name=e,this.options=s,this.$field=i,this.$container=i.closest(this.options.container),this.$message=this.options.message?this.getMessageElement():t(),this.$feedback=this.options.feedback?this.getFeedbackElement():t()}return i.prototype={defaults:{container:".form-group",delay:300,delayTriggers:["keyup"],rules:"",remoteRule:t.noop,triggers:["keyup","focusout","change"],message:!0,customMessages:{},feedback:!0,feedbackIcons:{success:'<i class="glyphicon glyphicon-check"></i>',error:'<i class="glyphicon glyphicon-remove"></i>'}},configDefaults:{validateOnSubmit:!0},DominarField:s,bindEvents:function(){var t=this;this.$form.on("keyup blur change","textarea, input, select",function(e){t.fireValidate.call(t,e)}),this.$form.on("submit",function(e){t.fireSubmit.call(t,e)})},getField:function(t){if("string"==typeof t)return this.fields[t];var e=t.attr("name"),i=this.fields[e];return!i&&this.options[e]&&(i=new this.DominarField(e,t,this.getOptions(e)),this.fields[e]=i,this.trigger("init-field",{dominarField:i})),i},getOptions:function(e){var i=this.options[e];return t.extend({},this.defaults,i)},add:function(t,e){var i=this;return t.each(function(){i.options[this.name]=e}),this},trigger:function(e,i,s){var i=t.extend({},{dominar:this},i),n=t.Event("dominar."+e,i);return this.$form.trigger(n),s&&!n.isDefaultPrevented()&&s(),n},fireValidate:function(e){var i=t(e.target),s=this.getField(i);s&&s.fireValidate(e)},fireSubmit:function(t){var e=this;if(e.config.validateOnSubmit){var i=function(){t.target.submit()},s=function(){e.trigger("submit-failed")},n=function(){t.preventDefault(),e.validateAll(function(){e.trigger("submit-passed",{},i)},function(){e.trigger("submit-failed",{},s)})};e.trigger("submit",{},n)}},validate:function(t,e,i){var s=this.getField(t);s&&s.validate(e,i)},validateDelayed:function(t,e,i){var s=this.getField(t);s&&s.validateDelayed(e,i)},validateAll:function(e,i){var s,n,a=[];e=e||t.noop,i=i||t.noop;for(var o in this.options)n=t.Deferred(),s=this.getField(o)||this.getField(this.$form.find('[name="'+o+'"]')),a.push(n),function(t,e){t.validate(function(){e.resolve()},function(t){e.reject(t)})}(s,n);return t.when.apply(t,a).done(e).fail(i)}},i.register=function(t,i,s){e.register(t,i,s)},s.prototype={validate:function(e,i){var s=this.getName(),n=this.getValue(),a=this,o=t.Deferred();e=e||t.noop,i=i||t.noop,this.validator&&delete this.validator,this.validator=this.getValidator(),t.when(o,this.options.remoteRule(n)).done(function(){a.showSuccess(),e()}).fail(function(t){"string"!=typeof t&&(t=t.responseJSON.message),a.showError(t),i(t)}),!this.validator||this.validator.passes()?o.resolve():o.reject(this.validator.errors.first(s))},validateDelayed:function(e,i){var s=this,n=this.options.delay;e=e||t.noop,i=i||t.noop,clearTimeout(this.delayTimer),n?this.delayTimer=setTimeout(function(){s.validate.apply(s,[e,i])},n):this.validate(e,i)},fireValidate:function(t){var e=this.getTrigger(t);e.validate&&(e.delay?this.validateDelayed():this.validate())},getValidationOptions:function(){var t=this.getName(),e={},i={};e[t]=this.getValue(),i[t]=this.getRules(),0===i[t].length&&delete i[t];var s={data:e,rules:i,customMessages:this.options.customMessages};return this.options.validatorOptions&&(s=this.options.validatorOptions.call(this,s)),s},getValidator:function(){var t=this.getValidationOptions(),i=new e(t.data,t.rules,t.customMessages);return i},getRules:function(){return this.options.rules},getName:function(){return this.name},getValue:function(){return this.$field.val()},getTrigger:function(e){var i=e.type,s="keyup"==i,n=t.inArray(i,this.options.triggers)>-1,a=t.inArray(i,this.options.delayTriggers)>-1,o=(s&&9!==e.keyCode||!s)&&n;return{validate:o,delay:a}},$form:function(){return this.$container.closest("form")},getMessageElement:function(){var e=this.$container.find(".help-block");return 0===e.length&&(e=t('<span class="help-block"/>').insertAfter(this.$field)),e},getFeedbackElement:function(){var e=this.$container.find(".form-control-feedback");return 0===e.length&&(e=t('<span class="form-control-feedback"/>').insertAfter(this.$message.length?this.$message:this.$field)),e},showError:function(t){this.reset(),this.$container.addClass("has-error"),this.options.message&&this.$message.html(t||""),this.options.feedback&&this.showFeedback("error")},showSuccess:function(t){this.reset(),this.$container.addClass("has-success"),this.options.message&&this.$message.html(t||""),this.options.feedback&&this.showFeedback("success")},showFeedback:function(t){this.$container.addClass("has-feedback"),this.$feedback.html(this.options.feedbackIcons[t])},reset:function(){this.$container.removeClass("has-error has-success has-feedback"),this.$message.empty(),this.$feedback.empty()}},i});